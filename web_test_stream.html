<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>RAG Agent Streaming Test (safe)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:900px;margin:24px auto;padding:0 12px}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0}
    input[type=text]{flex:1;padding:8px;border:1px solid #ccc;border-radius:8px}
    button{padding:8px 12px;border:1px solid #444;border-radius:8px;background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#666}
    .box{white-space:pre-wrap;border:1px solid #ddd;border-radius:8px;padding:12px;min-height:140px;background:#fafafa;overflow:auto}
    .meta{white-space:pre;min-height:120px}
    .badge{font-size:12px;color:#666}
  </style>
</head>
<body>
  <h2>RAG Agent Streaming Test</h2>

  <div class="row">
    <label>API base:
      <input id="base" type="text" value="http://127.0.0.1:8000" style="width:320px">
    </label>
    <label>Session ID:
      <input id="sid" type="text" value="demo001" style="width:180px">
    </label>
    <button id="reset" type="button" class="secondary">重置會話</button>
    <button id="seeHist" type="button" class="secondary">看歷史</button>
    <button id="clearOut" type="button" class="secondary">清空畫面</button>
    <span id="status" class="badge"></span>
  </div>

  <div class="row">
    <input id="q" type="text" placeholder="輸入問題，例如：VIP2 現貨 taker 手續費是多少？">
    <button id="send" type="button">送出</button>
  </div>

  <div class="row"><span class="badge">Streaming output</span></div>
  <div id="out" class="box" aria-live="polite"></div>

  <div class="row"><span class="badge">Meta（[meta] JSON）</span></div>
  <div id="meta" class="box meta"></div>

<script>
(() => {
  const $base = document.getElementById('base');
  const $sid  = document.getElementById('sid');
  const $q    = document.getElementById('q');
  const $out  = document.getElementById('out');
  const $meta = document.getElementById('meta');
  const $send = document.getElementById('send');
  const $reset= document.getElementById('reset');
  const $see  = document.getElementById('seeHist');
  const $clr  = document.getElementById('clearOut');
  const $status = document.getElementById('status');

  let busy = false;
  let controller = null;

  function addChunk(text){
    const span = document.createElement('span');
    span.textContent = text;
    $out.appendChild(span);
    $out.scrollTop = $out.scrollHeight;
  }
  function addLine(text){
    addChunk(text + "\n");
  }
  function setStatus(msg){ $status.textContent = msg || ""; }

  async function postStream() {
    if (busy) {
      // 取消上一條串流，避免互相清空與覆寫
      try { controller && controller.abort(); } catch (e) {}
    }
    busy = true;
    controller = new AbortController();
    setStatus("串流中…");

    const payload = { q: $q.value, session_id: $sid.value };
    let res;
    try {
      res = await fetch($base.value.replace(/\/$/,"") + "/stream", {
        method: "POST",
        headers: {"Content-Type":"application/json","Cache-Control":"no-store"},
        body: JSON.stringify(payload),
        signal: controller.signal
      });
    } catch (err) {
      addLine(`[error] ${err}`);
      busy = false; setStatus("");
      return;
    }
    if (!res.ok || !res.body) {
      addLine(`[error] HTTP ${res.status}`);
      busy = false; setStatus("");
      return;
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    try {
      while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, {stream:true});

        const lines = buffer.split(/\r?\n/);
        buffer = lines.pop() || "";
        for (const line of lines) {
          if (!line.startsWith("data:")) continue;
          const text = line.slice(5).trimStart();
          if (!text) continue;
          if (text.startsWith("[meta]")) {
            $meta.textContent = text.slice(6);
          } else if (text === "[DONE]") {
            // ignore
          } else {
            addChunk(text);
          }
        }
      }
      // 把最後殘留半行也吃掉
      if (buffer.startsWith("data:")) {
        const text = buffer.slice(5).trimStart();
        if (text && text !== "[DONE]") {
          if (text.startsWith("[meta]")) $meta.textContent = text.slice(6);
          else addChunk(text);
        }
      }
    } catch (err) {
      if (err.name !== "AbortError") addLine(`[error] ${err}`);
    } finally {
      busy = false; setStatus("");
    }
  }

  $send.addEventListener('click', () => {
    if (!$q.value.trim()) { $q.focus(); return; }
    // 不自動清畫面；要清請按「清空畫面」
    postStream();
  });

  $reset.addEventListener('click', async () => {
    try {
      const res = await fetch($base.value.replace(/\/$/,"") + "/session/reset", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ session_id: $sid.value })
      });
      addLine(res.ok ? "[info] 會話已重置" : `[error] reset fail: ${res.status}`);
    } catch (e) { addLine(`[error] ${e}`); }
  });

  $see.addEventListener('click', async () => {
    const url = $base.value.replace(/\/$/,"") + "/diag/history?session_id=" + encodeURIComponent($sid.value);
    const res = await fetch(url, {headers: {"Cache-Control":"no-store"}});
    const js = await res.json();
    $meta.textContent = JSON.stringify(js, null, 2);
  });

  $clr.addEventListener('click', () => {
    $out.textContent = "";
    // $meta.textContent = ""; // 如果也要清 meta 就打開
  });

  // Enter 送出（避免重複送出）
  $q.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !busy) $send.click(); });

  // 避免外部 reload 造成輸出清空（開檔建議用 file:// 或關 Live Server auto-reload）
})();
</script>
</body>
</html>
