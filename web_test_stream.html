<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>RAG Agent Streaming Test</title>
  <style>
    body{font-family:ui-sans-serif,system-ui,Segoe UI,Arial;max-width:900px;margin:24px auto;padding:0 12px}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0}
    input[type=text]{flex:1;padding:8px;border:1px solid #ccc;border-radius:8px}
    button{padding:8px 12px;border:1px solid #444;border-radius:8px;background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#666}
    pre{white-space:pre-wrap;border:1px solid #ddd;border-radius:8px;padding:12px;min-height:120px;background:#fafafa}
    small{color:#666}
    label{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body>
  <h2>RAG Agent Streaming Test</h2>

  <div class="row">
    <label>API base:
      <input id="base" type="text" value="http://127.0.0.1:8000" style="width:320px">
    </label>
    <label>Session ID:
      <input id="sid" type="text" value="demo001" style="width:180px">
    </label>
    <button id="reset" class="secondary" title="清空該 session 的歷史">重置會話</button>
    <button id="seeHist" class="secondary">看歷史</button>
  </div>

  <div class="row">
    <input id="q" type="text" placeholder="輸入問題，例如：VIP2 現貨 taker 手續費是多少？">
    <button id="send">送出</button>
  </div>

  <div class="row"><small>Streaming output</small></div>
  <pre id="out"></pre>

  <div class="row"><small>Meta（[meta] JSON）</small></div>
  <pre id="meta"></pre>

  <script>
  const $base = document.getElementById('base');
  const $sid  = document.getElementById('sid');
  const $q    = document.getElementById('q');
  const $out  = document.getElementById('out');
  const $meta = document.getElementById('meta');
  const $send = document.getElementById('send');
  const $reset= document.getElementById('reset');
  const $see  = document.getElementById('seeHist');

  // ✅ 避免默認提交造成刷新（若你外面包了 form）
  [$send, $reset, $see].forEach(b => b.setAttribute('type', 'button'));

  function appendOut(text){ $out.textContent += text; $out.scrollTop = $out.scrollHeight; }
  function clearOut(){ $out.textContent = ""; /* $meta.textContent = ""; 不自動清 meta */ }

  let busy = false;  // ✅ 請求鎖，避免重複送出

  async function postStream() {
    if (busy) return;  // 忙碌時忽略
    busy = true;

    // 若你想每次都清空輸出，再把下一行打開
    // clearOut();

    const payload = { q: $q.value, session_id: $sid.value };
    const res = await fetch($base.value.replace(/\/$/,"") + "/stream", {
      method: "POST",
      headers: {"Content-Type":"application/json", "Cache-Control":"no-store"},
      body: JSON.stringify(payload)
    }).catch(err => {
      appendOut(`\n[error] ${err}`);
      busy = false;
    });
    if (!res || !res.ok || !res.body) {
      appendOut(`\n[error] HTTP ${res ? res.status : 'no response'}`);
      busy = false;
      return;
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    try {
      while (true) {
        const {done, value} = await reader.read();
        buffer += value ? decoder.decode(value, {stream:true}) : "";

        // 逐行解析
        let lines = buffer.split(/\r?\n/);
        buffer = lines.pop() || "";  // 暫存半行

        for (const line of lines) {
          if (!line.startsWith("data:")) continue;
          const text = line.slice(5).trimStart();
          if (!text) continue;
          if (text.startsWith("[meta]")) {
            $meta.textContent = text.slice(6);
          } else if (text === "[DONE]") {
            // 結束事件，可忽略
          } else {
            appendOut(text);
          }
        }

        if (done) break;
      }

      // ✅ 流結束後，把最後殘留半行也處理掉
      if (buffer.startsWith("data:")) {
        const text = buffer.slice(5).trimStart();
        if (text && text !== "[DONE]") {
          if (text.startsWith("[meta]")) {
            $meta.textContent = text.slice(6);
          } else {
            appendOut(text);
          }
        }
      }
    } catch (err) {
      appendOut(`\n[error] ${err}`);
    } finally {
      busy = false;  // ✅ 釋放鎖
    }
  }

  $send.onclick = () => {
    if (!$q.value.trim()) { $q.focus(); return; }
    postStream();
  };

  $reset.onclick = async () => {
    const res = await fetch($base.value.replace(/\/$/,"") + "/session/reset", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ session_id: $sid.value })
    });
    appendOut(res.ok ? "\n[info] 會話已重置\n" : `\n[error] reset fail: ${res.status}\n`);
  };

  $see.onclick = async () => {
    const url = $base.value.replace(/\/$/,"") + "/diag/history?session_id=" + encodeURIComponent($sid.value);
    const res = await fetch(url, {headers: {"Cache-Control":"no-store"}});
    const js = await res.json();
    $meta.textContent = JSON.stringify(js, null, 2);
  };

  // Enter 快速送出（避免重複觸發）
  $q.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !busy) $send.click(); });
</script>
</body>
</html>
