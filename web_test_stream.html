<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>RAG Agent Streaming Test</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:900px;margin:24px auto;padding:0 12px}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0}
    input[type=text]{flex:1;padding:8px;border:1px solid #ccc;border-radius:8px}
    button{padding:8px 12px;border:1px solid #444;border-radius:8px;background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#666}
    .box{white-space:pre-wrap;border:1px solid #ddd;border-radius:8px;padding:12px;min-height:140px;background:#fafafa;overflow:auto}
    .meta{white-space:pre;min-height:120px}
    .badge{font-size:12px;color:#666}
  </style>
</head>
<body>
  <h2>RAG Agent Streaming Test</h2>

  <div class="row">
    <label>API base:
      <input id="base" type="text" value="http://127.0.0.1:8000" style="width:320px">
    </label>
    <label>Session ID:
      <input id="sid" type="text" value="demo001" style="width:180px">
    </label>
    <button id="reset" type="button" class="secondary">é‡ç½®æœƒè©±</button>
    <button id="seeHist" type="button" class="secondary">çœ‹æ­·å²</button>
    <button id="seePrompt" type="button" class="secondary">ğŸª„ çœ‹æœ¬æ¬¡ Prompt</button> <!-- ğŸª„ æ–°å¢ -->
    <button id="clearOut" type="button" class="secondary">æ¸…ç©ºç•«é¢</button>
    <span id="status" class="badge"></span>
  </div>

  <div class="row">
    <input id="q" type="text" placeholder="è¼¸å…¥å•é¡Œï¼Œä¾‹å¦‚ï¼šVIP2 ç¾è²¨ taker æ‰‹çºŒè²»æ˜¯å¤šå°‘ï¼Ÿ">
    <button id="send" type="button">é€å‡º</button>
  </div>

  <div class="row"><span class="badge">Streaming output</span></div>
  <div id="out" class="box" aria-live="polite"></div>

  <div class="row"><span class="badge">Metaï¼ˆ[meta] JSONï¼‰</span></div>
  <div id="meta" class="box meta"></div>

  <!-- ğŸª„ é¡å¤–åŠ ä¸€å€‹å°ˆé–€é¡¯ç¤ºã€Œæœ¬æ¬¡æ¨¡å‹ Promptã€çš„å€å¡Š -->
  <div class="row"><span class="badge">ğŸª„ Last Prompt (æ¨¡å‹å¯¦éš›åƒåˆ°çš„å…§å®¹)</span></div>
  <div id="prompt" class="box meta"></div>

<script>
(() => {
  const $base = document.getElementById('base');
  const $sid  = document.getElementById('sid');
  const $q    = document.getElementById('q');
  const $out  = document.getElementById('out');
  const $meta = document.getElementById('meta');
  const $prompt = document.getElementById('prompt'); // ğŸª„ æ–°å¢
  const $send = document.getElementById('send');
  const $reset= document.getElementById('reset');
  const $see  = document.getElementById('seeHist');
  const $seePrompt = document.getElementById('seePrompt'); // ğŸª„ æ–°å¢
  const $clr  = document.getElementById('clearOut');
  const $status = document.getElementById('status');

  let busy = false;
  let controller = null;

  function addChunk(text){
    const span = document.createElement('span');
    span.textContent = text;
    $out.appendChild(span);
    $out.scrollTop = $out.scrollHeight;
  }
  function addLine(text){
    addChunk(text + "\n");
  }
  function setStatus(msg){ $status.textContent = msg || ""; }

  async function postStream() {
    if (busy) {
      try { controller && controller.abort(); } catch (e) {}
    }
    busy = true;
    controller = new AbortController();
    setStatus("ä¸²æµä¸­â€¦");

    const payload = { q: $q.value, session_id: $sid.value };
    let res;
    try {
      res = await fetch($base.value.replace(/\/$/,"") + "/stream", {
        method: "POST",
        headers: {"Content-Type":"application/json","Cache-Control":"no-store"},
        body: JSON.stringify(payload),
        signal: controller.signal
      });
    } catch (err) {
      addLine(`[error] ${err}`);
      busy = false; setStatus("");
      return;
    }
    if (!res.ok || !res.body) {
      addLine(`[error] HTTP ${res.status}`);
      busy = false; setStatus("");
      return;
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    try {
      while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, {stream:true});
        const lines = buffer.split(/\r?\n/);
        buffer = lines.pop() || "";
        for (const line of lines) {
          if (!line.startsWith("data:")) continue;
          const text = line.slice(5).trimStart();
          if (!text) continue;
          if (text.startsWith("[meta]")) {
            $meta.textContent = text.slice(6);
          } else if (text === "[DONE]") {
            // ignore
          } else {
            addChunk(text);
          }
        }
      }
      if (buffer.startsWith("data:")) {
        const text = buffer.slice(5).trimStart();
        if (text && text !== "[DONE]") {
          if (text.startsWith("[meta]")) $meta.textContent = text.slice(6);
          else addChunk(text);
        }
      }
    } catch (err) {
      if (err.name !== "AbortError") addLine(`[error] ${err}`);
    } finally {
      busy = false; setStatus("");
    }
  }

  $send.addEventListener('click', () => {
    if (!$q.value.trim()) { $q.focus(); return; }
    postStream();
  });

  $reset.addEventListener('click', async () => {
    try {
      const res = await fetch($base.value.replace(/\/$/,"") + "/session/reset", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ session_id: $sid.value })
      });
      addLine(res.ok ? "[info] æœƒè©±å·²é‡ç½®" : `[error] reset fail: ${res.status}`);
    } catch (e) { addLine(`[error] ${e}`); }
  });

  $see.addEventListener('click', async () => {
    const url = $base.value.replace(/\/$/,"") + "/diag/history?session_id=" + encodeURIComponent($sid.value);
    const res = await fetch(url, {headers: {"Cache-Control":"no-store"}});
    const js = await res.json();
    $meta.textContent = JSON.stringify(js, null, 2);
  });

  // ğŸª„ æ–°å¢ï¼šæŸ¥çœ‹æœ¬æ¬¡é€é€²æ¨¡å‹çš„ Prompt
  $seePrompt.addEventListener('click', async () => {
    const url = $base.value.replace(/\/$/,"") + "/diag/last_prompt?session_id=" + encodeURIComponent($sid.value) + "&clip=4000";
    try {
      const res = await fetch(url, {headers: {"Cache-Control":"no-store"}});
      if (!res.ok) {
        $prompt.textContent = `[error] ${res.status}`;
        return;
      }
      const js = await res.json();
      $prompt.textContent = JSON.stringify(js, null, 2);
    } catch (e) {
      $prompt.textContent = `[error] ${e}`;
    }
  });

  $clr.addEventListener('click', () => {
    $out.textContent = "";
  });

  $q.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !busy) $send.click(); });

})();
</script>
</body>
</html>
