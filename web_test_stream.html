<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>RAG Agent Streaming & Upload</title>
  <style>
    body {
      font-family: system-ui, Segoe UI, Arial;
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 12px;
      overflow-x: hidden; /* ç¦æ­¢æ°´å¹³æ»¾å‹• */
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 8px 0;
      flex-wrap: wrap;
    }
    input[type=text] {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      padding: 8px 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #111;
      color: #fff;
      cursor: pointer;
    }
    button.secondary { background: #666; }
    .box {
      white-space: pre-wrap;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      min-height: 140px;
      max-height: 300px;  /* å›ºå®šé«˜åº¦ */
      background: #fafafa;
      overflow-y: auto;   /* å‚ç›´æ»¾å‹• */
      overflow-x: hidden;
      word-wrap: break-word;
      word-break: break-word;
    }
    .meta {
      white-space: pre-wrap;
      max-height: 240px;
      overflow-y: auto;
      overflow-x: hidden;
      font-size: 13px;
    }
    .badge { font-size: 12px; color: #666; }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 420px; /* å³æ¬„å›ºå®šå¯¬ */
      gap: 16px;
      align-items: start;
      width: 100%;
      max-width: 1200px;
      overflow-x: hidden;
    }
    .list {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow-y: auto;
      max-height: 220px;
      background: #fff;
      overflow-x: hidden;
    }
    .list-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-family: ui-monospace, monospace;
      word-break: break-all;
      cursor: pointer;
    }
    .list-item:last-child { border-bottom: none; }
    .muted { color: #777; }
  </style>
</head>
<body>
  <h2>RAG Agent â€” Streaming + Upload</h2>

  <div class="row">
    <label>API base:
      <input id="base" type="text" value="http://127.0.0.1:8000" style="width:320px">
    </label>
    <label>Session ID:
      <input id="sid" type="text" value="demo001" style="width:180px">
    </label>
    <button id="reset" type="button" class="secondary">é‡ç½®æœƒè©±</button>
    <button id="seeHist" type="button" class="secondary">çœ‹æ­·å²</button>
    <button id="seePrompt" type="button" class="secondary">ğŸª„ çœ‹æœ¬æ¬¡ Prompt</button>
    <button id="clearOut" type="button" class="secondary">æ¸…ç©ºç•«é¢</button>
    <span id="status" class="badge"></span>
  </div>

  <div class="grid">
    <!-- å·¦å´ï¼šèŠå¤©ä¸²æµ -->
    <section>
      <div class="row">
        <input id="q" type="text" placeholder="è¼¸å…¥å•é¡Œï¼Œä¾‹å¦‚ï¼šLevel 3 çš„è‚¡ç¥¨åŸºé‡‘æ‰‹çºŒè²»æ˜¯å¤šå°‘ï¼Ÿ">
        <button id="send" type="button">é€å‡º</button>
      </div>

      <div class="row"><span class="badge">Streaming output</span></div>
      <div id="out" class="box" aria-live="polite"></div>

      <div class="row"><span class="badge">Metaï¼ˆ[meta] JSONï¼‰</span></div>
      <div id="meta" class="box meta"></div>

      <div class="row"><span class="badge">ğŸª„ Last Prompt (æ¨¡å‹å¯¦éš›åƒåˆ°çš„å…§å®¹)</span></div>
      <div id="prompt" class="box meta"></div>
    </section>

    <!-- å³å´ï¼šå¤šæ¨¡æ…‹ä¸Šå‚³ -->
    <aside>
      <h3>ğŸ†™ å¤šæ¨¡æ…‹ä¸Šå‚³ï¼ˆPDF / åœ–ç‰‡ â†’ æŠ½å– â†’ å…¥åº«ï¼‰</h3>
      <div class="row">
        <input id="file" type="file" multiple accept=".pdf,.png,.jpg,.jpeg,.bmp,.webp" />
        <button id="btnUpload" type="button">ä¸Šå‚³</button>
      </div>
      <div class="row">
        <button id="btnList" class="secondary" type="button">åˆ—å‡ºå·²ä¸Šå‚³</button>
        <button id="btnPreview" class="secondary" type="button">é è¦½æŠ½å–</button>
        <button id="btnIngest" class="secondary" type="button">å…¥åº«é¸å–</button>
      </div>
      <div class="badge">é»æ“Šæ¸…å–®é …ç›®å¯ã€Œé¸å– / å–æ¶ˆé¸å–ã€ã€‚è—åº• = å·²é¸å–ã€‚</div>
      <div id="fileList" class="list"></div>

      <div class="row" style="margin-top:12px"><span class="badge">æŠ½å–é è¦½ï¼ˆå‰500å­—ï¼‰</span></div>
      <div id="preview" class="box meta"></div>
    </aside>
  </div>

<script>
(() => {
  const $base = document.getElementById('base');
  const $sid  = document.getElementById('sid');
  const $q    = document.getElementById('q');
  const $out  = document.getElementById('out');
  const $meta = document.getElementById('meta');
  const $prompt = document.getElementById('prompt');
  const $send = document.getElementById('send');
  const $reset= document.getElementById('reset');
  const $see  = document.getElementById('seeHist');
  const $seePrompt = document.getElementById('seePrompt');
  const $clr  = document.getElementById('clearOut');
  const $status = document.getElementById('status');

  const $file = document.getElementById('file');
  const $btnUpload = document.getElementById('btnUpload');
  const $btnList = document.getElementById('btnList');
  const $btnPreview = document.getElementById('btnPreview');
  const $btnIngest = document.getElementById('btnIngest');
  const $fileList = document.getElementById('fileList');
  const $preview = document.getElementById('preview');

  let busy = false;
  let controller = null;
  let selected = new Set();

  /* ======== ä¸²æµï¼šæ¨¡å‹è¼¸å‡ºç´¯ç©æˆå–®ä¸€å¡ç‰‡ ======== */
  let modelBuf = "";
  let modelLiveEl = null;

  function toHTML(text) {
    const esc = text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
    return esc
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
      .replace(/`([^`]+)`/g, "<code style='background:#eee;padding:2px 4px;border-radius:4px;'>$1</code>")
      .replace(/\n/g, "<br>");
  }

  function renderModelLive() {
    if (!modelLiveEl) {
      modelLiveEl = document.createElement("div");
      modelLiveEl.style.margin = "8px 0";
      modelLiveEl.style.padding = "8px 10px";
      modelLiveEl.style.borderLeft = "4px solid #0070f3";
      modelLiveEl.style.background = "#f2f9ff";
      modelLiveEl.style.borderRadius = "6px";
      modelLiveEl.style.lineHeight = "1.6";
      modelLiveEl.style.fontSize = "15px";
      $out.appendChild(modelLiveEl);
    }
    modelLiveEl.innerHTML = toHTML(modelBuf);
    $out.scrollTop = $out.scrollHeight;
  }

  function flushModel() {
    if (modelLiveEl) {
      // å·²å®šå‹çš„å¡ç‰‡å°±ä¿ç•™åœ¨ç•«é¢ï¼›åªæŠŠæŒ‡æ¨™æ¸…æ‰æº–å‚™ä¸‹ä¸€è¼ª
      modelLiveEl = null;
    }
    modelBuf = "";
  }

  function addChunk(text) {
    if (text.startsWith("[meta]")) {
      flushModel();
      $meta.textContent = text.slice(6);
      return;
    }
    if (text.startsWith("[debug]") || text.startsWith("[warn]") || text.startsWith("[error]")) {
      flushModel();
      const p = document.createElement("p");
      p.textContent = text;
      p.style.color = "#888";
      p.style.fontSize = "13px";
      p.style.margin = "6px 0";
      $out.appendChild(p);
      $out.scrollTop = $out.scrollHeight;
      return;
    }
    if (text.startsWith("[thinking]")) {
      flushModel();
      const p = document.createElement("p");
      p.textContent = "ğŸ¤” " + text.replace("[thinking]", "").trim();
      p.style.color = "#0070f3";
      p.style.fontWeight = "600";
      p.style.margin = "6px 0";
      $out.appendChild(p);
      $out.scrollTop = $out.scrollHeight;
      return;
    }
    if (text === "[DONE]") {
      flushModel();
      return;
    }
    // æ¨¡å‹çœŸå¯¦å›è¦†ï¼šç´¯ç©ä¸¦å³æ™‚æ›´æ–°å–®ä¸€å¡ç‰‡
    modelBuf += text;
    renderModelLive();
  }

  async function postStream() {
    if (busy) { try { controller && controller.abort(); } catch (e) {} }
    busy = true; controller = new AbortController(); setStatus("ä¸²æµä¸­â€¦");
    flushModel(); // æ–°ä¸€è¼ªé–‹å§‹å‰æ¸…å‰ä¸€æ¬¡ç‹€æ…‹

    const payload = { q: $q.value, session_id: $sid.value };

    let res;
    try {
      res = await fetch($base.value.replace(/\/$/,"") + "/stream", {
        method: "POST",
        headers: {"Content-Type":"application/json","Cache-Control":"no-store"},
        body: JSON.stringify(payload),
        signal: controller.signal
      });
    } catch (err) { addChunk(`[error] ${err}`); busy=false; setStatus(""); return; }
    if (!res.ok || !res.body) { addChunk(`[error] HTTP ${res.status}`); busy=false; setStatus(""); return; }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    try {
      while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, {stream:true});
        const lines = buffer.split(/\r?\n/);
        buffer = lines.pop() || "";
        for (const line of lines) {
          if (!line.startsWith("data:")) continue;
          const text = line.slice(5).trimStart();
          if (!text) continue;
          addChunk(text);
        }
      }
      if (buffer.startsWith("data:")) {
        const text = buffer.slice(5).trimStart();
        if (text) addChunk(text);
      }
    } catch (err) {
      if (err.name !== "AbortError") addChunk(`[error] ${err}`);
    } finally {
      flushModel();            // æ”¶å°¾ä¿éšª
      busy = false; setStatus("");
    }
  }

  function addLine(text){
    const p = document.createElement('p');
    p.textContent = text;
    $out.appendChild(p);
    $out.scrollTop = $out.scrollHeight;
  }
  function setStatus(msg){ $status.textContent = msg || ""; }

  $send.onclick = () => { if (!$q.value.trim()) { $q.focus(); return; } postStream(); };
  $reset.onclick = async () => {
    const res = await fetch($base.value.replace(/\/$/,"") + "/session/reset", {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ session_id: $sid.value })
    });
    addLine(res.ok ? "[info] æœƒè©±å·²é‡ç½®" : `[error] reset fail: ${res.status}`);
  };
  $see.onclick = async () => {
    const url = $base.value.replace(/\/$/,"") + "/diag/history?session_id=" + encodeURIComponent($sid.value);
    const res = await fetch(url, {headers: {"Cache-Control":"no-store"}});
    const js = await res.json();
    $meta.textContent = JSON.stringify(js, null, 2);
  };
  $seePrompt.onclick = async () => {
    const url = $base.value.replace(/\/$/,"") + "/diag/last_prompt?session_id=" + encodeURIComponent($sid.value) + "&clip=4000";
    const res = await fetch(url, {headers: {"Cache-Control":"no-store"}});
    $prompt.textContent = res.ok ? JSON.stringify(await res.json(), null, 2) : `[error] ${res.status}`;
  };
  $clr.onclick = () => { $out.textContent = ""; };
  $q.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !busy) $send.click(); });

  /* ======== ä¸Šå‚³/æŠ½å–/å…¥åº« ======== */
  function renderList(files){
    $fileList.innerHTML = "";
    selected.clear();
    for (const f of files) {
      const div = document.createElement("div");
      div.className = "list-item";
      div.dataset.name = f.name;
      div.onclick = () => {
        if (selected.has(f.name)) {
          selected.delete(f.name); div.style.background = "";
        } else {
          selected.add(f.name); div.style.background = "#e6f0ff";
        }
      };
      const left = document.createElement("div");
      left.textContent = f.name;
      const right = document.createElement("div");
      right.className = "muted";
      right.textContent = `${(f.bytes/1024).toFixed(1)} KB`;
      div.appendChild(left); div.appendChild(right);
      $fileList.appendChild(div);
    }
    if (!files.length) $fileList.innerHTML = '<div class="list-item muted">ï¼ˆç›®å‰æ²’æœ‰å·²ä¸Šå‚³æª”æ¡ˆï¼‰</div>';
  }

  async function listFiles(){
    const url = $base.value.replace(/\/$/,"") + "/files";
    const res = await fetch(url, {headers: {"Cache-Control":"no-store"}});
    const js = await res.json();
    renderList(js.files || []);
  }

  async function uploadFiles(){
    if (!$file.files.length) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ"); return; }
    for (const f of $file.files) {
      const fd = new FormData();
      fd.append("file", f, f.name);
      const res = await fetch($base.value.replace(/\/$/,"") + "/upload", {
        method: "POST",
        body: fd
      });
      if (!res.ok) addLine(`[upload error] ${f.name} -> ${res.status}`);
      else {
        const j = await res.json();
        addLine(`[upload ok] ${f.name} (${j.size} bytes)`);
      }
    }
    await listFiles();
  }

  async function previewExtract(){
    if (!selected.size) { alert("è«‹å…ˆåœ¨æ¸…å–®é¸å– 1 å€‹æª”æ¡ˆ"); return; }
    $preview.textContent = "æŠ½å–ä¸­â€¦";
    const name = Array.from(selected)[0];
    const url = $base.value.replace(/\/$/,"") + "/diag/extract?name=" + encodeURIComponent(name);
    const res = await fetch(url, {headers: {"Cache-Control":"no-store"}});
    $preview.textContent = res.ok ? JSON.stringify(await res.json(), null, 2) : `[error] ${res.status}`;
  }

  async function ingestSelected(){
    if (!selected.size) { alert("è«‹å…ˆåœ¨æ¸…å–®é¸å–è‡³å°‘ 1 å€‹æª”æ¡ˆ"); return; }
    const names = Array.from(selected);
    const res = await fetch($base.value.replace(/\/$/,"") + "/ingest/uploads", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ names })
    });
    const js = await res.json();
    addLine(res.ok ? `[ingest ok] æ–°å¢ ${js.added} ç­† chunks` : `[ingest error] ${res.status}`);
  }

  $btnUpload.onclick = uploadFiles;
  $btnList.onclick = listFiles;
  $btnPreview.onclick = previewExtract;
  $btnIngest.onclick = ingestSelected;

  // åˆå§‹ï¼šåˆ—å‡ºå·²ä¸Šå‚³
  listFiles();
})();
</script>
</body>
</html>
